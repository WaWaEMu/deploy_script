# Deployment Script

## üöÄ Deployment Flow
`init` ‚Üí `prepare` ‚Üí *(üîå manually connect VPN)* ‚Üí `apply`  
*(Setup tracking ‚Üí Generate diffs ‚Üí Connect VPN ‚Üí Deploy changes)*

## Overview

`deploy_script` is a lightweight deployment tool designed for scenarios where the production environment is isolated or restricted, making fully automated deployment impossible. Its main purpose is to **simplify manual deployment while ensuring version consistency** between your Git repository and the production server.

### ‚ú® Key points
- Suitable for environments without full automation.
- Ensures version consistency between repository and production.
- Simplifies manual deployment with a clear step-by-step workflow.

---

## Prerequisites / Setup

### Prerequisites

- Git installed on your local machine
- SSH access to the target repository
- Basic knowledge of Git branches and commits

### Obtain deploy_script

Clone or download the deployment script repository to your local machine:

```bash
git clone <DEPLOY_SCRIPT_REPO_URL> ~/deploy_script
cd ~/deploy_script
```

### Configuration (`deploy.conf`)

Before deploying, update the `deploy.conf` file with your environment-specific settings.

#### Git Repository
- `CLONE_MODE` ‚Äì `"SSH"` or `"HTTPS"`
- `SSH_REPO_URL` ‚Äì SSH repository URL
- `HTTPS_REPO_URL` ‚Äì HTTPS repository URL
- `GIT_USERNAME`/`GIT_PASSWORD` ‚Äì for HTTPS access
- `DEPLOY_BRANCH` ‚Äì Target branch (e.g., `"main"`)

#### Local Environment
- `LOCAL_ROOT` ‚Äì Local clone path
- `DEPLOY_VERSION` ‚Äì File tracking the last deployed commit
- `LOG_FILE` ‚Äì Log file path

#### Connection Settings
- `VPN_CHECK_IP` ‚Äì Optional VPN connectivity check
- `SSH_USER`/`SSH_HOST`/`SSH_PORT` ‚Äì SSH access info
- `SSH_KEY_PATH` ‚Äì SSH private key path

#### Production Environment
- `PROD_ROOT` ‚Äì Production file root directory
- `BACKUP_DIR` ‚Äì Directory for pre-deployment backups

> **Tip:** Ensure the SSH user can write to PROD_ROOT and can manually connect using `ssh $SSH_USER@$SSH_HOST`.

## Usage

### `init` ‚Äì Initialize Deployment Tracking

Initializes your local repository and sets up deployment tracking so the script knows which commit is currently deployed.

```bash
./deploy.sh init
```

#### What happens:

1. Sets repository URL based on `CLONE_MODE`

2. Verifies or clones repository, and checks out target branch

3. Initializes `DEPLOY_VERSION` (asks for current production commit if missing)

4. Confirms that the commit exists in the repository

### `prepare` ‚Äì Generate Deployment Differences

Compares the last deployed commit with the latest commit on the target branch, then generates `.old` and `.new` files under `version_diff/`.

```bash
./deploy.sh prepare
```

#### What happens:

1. Validates repository and deployment tracking.

2. Detects changed files between commits.

3. Saves old/new file versions and metadata under `version_diff`/ for the next step (`apply`).

## ‚ö†Ô∏è Manual Step: Connect VPN

Before running `apply`, make sure you are connected to the production network (VPN).

## apply ‚Äì Apply Deployment
Applies prepared changes to the production environment over SSH.

```bash
./deploy.sh apply
```

#### What happens:

1. Ensures SSH access to the target server.

2. Verifies diff and version files generated by prepare.

3. Checks that remote files match old versions before applying.

4. Uploads changed files via SCP and updates deployment records.
